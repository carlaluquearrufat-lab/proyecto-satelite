#include <SoftwareSerial.h>
SoftwareSerial mySerial(10, 11); // RX, TX del LoRa

#define ID_GRUPO 14 // Solo aceptamos mensajes de este grupo

// ----------------- Funciones -----------------
float leerFloat(byte* mensaje, int indice) {
  union { float f; byte b[4]; } data;
  for (int i = 0; i < 4; i++) data.b[i] = mensaje[indice + i];
  return data.f;
}

byte calcularChecksum(byte* mensaje, int largo) {
  int suma = 0;
  for (int i = 0; i < largo; i++) suma += mensaje[i];
  return suma % 256;
}

// ----------------- Setup -----------------
void setup() {
  Serial.begin(9600);
  mySerial.begin(9600);
}

// ----------------- Loop -----------------
void loop() {
  const int largoDatos = 9; // 1 ID + 2 floats (8 bytes)
  byte mensaje[largoDatos + 1]; // +1 para checksum

  if (mySerial.available() >= (largoDatos + 1)) {
    mySerial.readBytes(mensaje, largoDatos + 1);

    byte checksumRecibido = mensaje[largoDatos];
    byte checksumCalculado = calcularChecksum(mensaje, largoDatos);

    // Verificar checksum
    if (checksumRecibido != checksumCalculado) {
      Serial.println("Mensaje corrupto, checksum no coincide");
      return;
    }

    // Verificar ID de grupo
    if (mensaje[0] != ID_GRUPO) {
      Serial.println("Mensaje de otro grupo, se descarta");
      return;
    }

    // Reconstruir floats
    float h = leerFloat(mensaje, 1); // Humedad
    float t = leerFloat(mensaje, 5); // Temperatura

    Serial.print("Humedad: "); Serial.print(h);
    Serial.print("%\tTemperatura: "); Serial.println(t);
  }
}
