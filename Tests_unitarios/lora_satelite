#include <DHT.h>
#include <SoftwareSerial.h>

#define DHTPIN 2
#define DHTTYPE DHT11
DHT dht(DHTPIN, DHTTYPE);

#define ID_GRUPO 14 // ID de tu satélite

SoftwareSerial mySerial(10, 11); // RX, TX del LoRa

// ----------------- Funciones -----------------
void floatABytes(float valor, byte* mensaje, int indice) {
  union { float f; byte b[4]; } data;
  data.f = valor;
  for (int i = 0; i < 4; i++) mensaje[indice + i] = data.b[i];
}

byte calcularChecksum(byte* mensaje, int largo) {
  int suma = 0;
  for (int i = 0; i < largo; i++) suma += mensaje[i];
  return suma % 256;
}

void enviarMensajeConChecksum(byte* mensaje, int largo) {
  byte checksum = calcularChecksum(mensaje, largo);
  for (int i = 0; i < largo; i++) mySerial.write(mensaje[i]);
  mySerial.write(checksum);
}

// ----------------- Setup -----------------
void setup() {
  Serial.begin(9600);
  mySerial.begin(9600);
  dht.begin();
}

// ----------------- Loop -----------------
void loop() {
  delay(2000);

  float h = dht.readHumidity();
  float t = dht.readTemperature();

  if (isnan(h) || isnan(t)) {
    Serial.println("Error al leer el sensor DHT11");
  } else {
    // Construir mensaje con ID + 2 floats
    byte mensaje[9]; // 1 ID + 2 floats (8 bytes)
    mensaje[0] = ID_GRUPO;       // ID de grupo
    floatABytes(h, mensaje, 1);  // Humedad
    floatABytes(t, mensaje, 5);  // Temperatura

    // Enviar mensaje con checksum
    enviarMensajeConChecksum(mensaje, 9);

    // Opcional: mostrar en Serial para depuración
    Serial.print("Enviado H: "); Serial.print(h);
    Serial.print("%  T: "); Serial.println(t);
  }
}
